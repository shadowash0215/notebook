<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>ASM - shadowash's notebook</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/darcula.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">shadowash's notebook</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../CSAPP/" class="nav-link">CSAPP</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">ASM</a>
                            </li>
                            <li class="navitem">
                                <a href="../LinearAlgebra/" class="nav-link">LinearAlgebra</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../CSAPP/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../LinearAlgebra/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/shadowash0215/edit/master/docs/ASM.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#_1" class="nav-link">汇编语言</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#39" class="nav-link">3.9</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#316" class="nav-link">3.16</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="_1">汇编语言</h1>
<h2 id="39"><em>3.9</em></h2>
<p>一般来说，三个 push+ 一个 call 表示程序在调用 main 函数,其之前的代码为 C 语言的初始化代码.<br />
OD 中 F2 为设置断点, F7 为跟踪进入.<br />
数据窗中 Ctrl+G 可以跟踪变量.  </p>
<p>有某些商用的对 exe 进行压缩的软件,如 Pecompact,VmProtect 可以把 exe 压缩为 exe ,压缩以后的 exe 也能双击运行.<br />
软件作者调用以下函数 sn<br />
sn = rsa(mac,私钥)<br />
软件检测 sn 是否正确<br />
rsa = (sn,公钥) == mac<br />
nop指令指什么也不做,no operation,机器码为 0x90.<br />
alt+backspace 可将改坏的指令恢复原样.<br />
搜索时使用较长的串以获取想要的结果.<br />
用十六进制编辑工具如 010editor 或 QuickView 都可以对 password.exe 进行搜索并修改.<br />
010editor 中按 Ctrl+F 输入要查找的串(Type 要注意修改为 hex bytes).<br />
QV 打开 password.exe,按回车键可以在 ascii/hex/asm 三种模式中切换,asm 模式有两种: 16位/32位,按 F2 切换(查看最下方状态栏或寄存器字母数).<br />
F7 进行搜索,tab 键在 ascii/hex 间切换,左上角编辑内有粘贴.<br />
F3 可将改坏的内容变为原样,tab 键可从左侧机器语言切换到右侧汇编指令,输入汇编语言进行修改,alt+F9 保存修改,F1 可获取帮助.<br />
md5 加密算法(但已经被证明无法防止碰撞).</p>
<pre><code>.data #编译指示语句,表示变量、数组定义从此处开始.汇编语言中单引号及双引号无区别,他们既可以引住单个字符,又可以引住多个字符;
#字符串末尾并没有隐含的'\0';定义数组和定义变量无区别.
result db 100 dup(0) #dup:duplicate
# == char result={0}
format db &quot;%d&quot;,0
prompt db &quot;The result&quot;,0

.code #编译指示语句，帮助编译器识别代码从此处开始   
main:       #标号
    mov eax,0
    mov ebx,1
next:
    add eax,ebx #eax = eax + ebx
    add ebx,1 
    cmp ebx,100 #cmp:compare
    jbe next #jbe:jump if below or equal
invoke wsprintf,offset result,offset format,eax #wsprintf 和 MessageboxA 是 Windows 操作系统下的函数 offset 为取地址.
# == wsprintf(&amp;result[0],&amp;format[0],eax); 将 eax 中的内容以 char 类型 format 数组的格式输出到 char 类型 result 数组中.
# == wsprintf(result,format,eax) result 中将包含&quot;5050&quot; &quot;%d&quot;.
invoke MessageBoxA,0,offset result,offset prompt,0 #称为 API (Application Program Interface).
MessageboxA(0,format,prompt,0)
                #正文 标题
    ret #return
end main #指定程序的起始执行点即eip的初始值,end 后面的标号决定了程序刚开始运行时eip的值.
</code></pre>
<pre><code>.386 #表示会用到32位的寄存器.
code segment use16 #相当于'{',use16表示使用16位的地址.

assume cs:code
main:       
    mov eax,0
    mov ebx,1
next:
    add eax,ebx 
    add ebx,1 
    cmp ebx,100 
    jbe next 
code ends #相当于'}'
end main
</code></pre>
<p>Win+R 输入 command 打开 DOS 终端,进入 D 盘中的 MASM 目录中,masm name.asm 生成 name.obj,link name.obj 生成 name.exe.<br />
使用 td name.exe 进行 debug,按 Ctrl+R/在寄存器界面单击右键切换32位/16位的寄存器.<br />
cli 是一条特权指令,含义为 clear interrup,表示禁止硬件中断.<br />
Windows的用户程序是不允许执行该条指令的.  </p>
<pre><code>#输入和输出,并判断是否为大写字母(getchar&amp;putchar)
.386
code segment use16
assume cs:code
main:
    mov ah, 1
    int 21h #AL = getchar(),int 21h 是一个中断集,int:interrupt,指软件中断,ah = 1 表示调用该中断集中的1号子中断.
    cmp al, 'A'
    jb not_upper #jb:jump if below
    cmp al, 'Z'
    ja not_upper #ja:jump if above
is_upper:
    mov ah, 2
    mov dl, 'U'
    int 21h #putchar(DL)
    jmp exit
not_upper:
    mov ah, 2
    mov dl, 'O'
    int 21h
exit:
    move ah, 4Ch
    move al, 0
    int 21h #exit(0)
code ends
end main
</code></pre>
<h2 id="316"><em>3.16</em></h2>
<pre><code>data segment
a db &quot;ABC&quot;
s db &quot;Hello$World!&quot;, 0Dh, 0Ah ,0 #函数经过编译后变为其首地址,数组经过编译后也变为其首地址.为防止与寄存器混淆,字母开头的十六进制数前需要加上0.
#                                offset s 称为 s 的偏移地址 = 其离 data 段首的距离 = 3 
#                   回车 换行     windows 中换到下一行行首需要回车和换行两个操.
#                   &quot;\r&quot;&quot;\n&quot;     回车:光标回到行首;换行:光标移动到下一行同一列.
data ends

code segment 
assume cs:code,ds:data
main:
    mov ax,seg s #或mov ax,data;seg s:取数组 s 的段地址.
    mon ds,ax #ds:数据段寄存器,只用来存储标号或变量的段地址,不能接受常数赋值,只接受另一个寄存器/变量赋值,另外还有 cs,ss,es 这三个段寄存器.
    mov bx,0
next:            #s[i] = *(s+i)
    mov dl,s[bx] #编译后变成 mov dl,ds:[bx + 3];ds 指该数组元素的段地址(segment address),该数组元素的偏移地址为 3,该元素的完整地址为 ds:bx + 3
    cmp dl,0
    je exit #je:jump if equal
    move ah,2
    int 21h
    add bx,1
    jmp next
exit:         # cs = seg exit = code 的段地址.
    mov ah,4Ch
    int 21h
code ends
end main
</code></pre>
<p>同一个段内每一个变量的段地址都是一样的，为段首地址取前四位,个位必须为0,偏移地址的变化范围为 0000h:FFFFh.段的最大长度为 10000h 字节即 64k;段和段可以重叠.
|物理地址|相对地址|
|:---|---:|
|12340h|00h|
|12341h|01h|
|…………|…………|
|12350h|33h|
|…………|…………|
|12398h|33h|
|…………|…………|
|12398h|55h|
|…………|…………|
|2233Fh|77h|
|…………|…………|
|2234Fh|99h|</p>
<p>16 位的 CPU 指其所有寄存器都是 16 位的宽度;ax,bx,cx,dx,si,di,bp,sp,cs,ds,es,ss,ip,FL.<br />
bx,bp,si,di 表示偏移地址,cs 管理 code 段,ds 管理 data 段,两者必须被赋值.<br />
标号最终会转化为其偏移地址.<br />
ip 是 指令指针(instruction pointer),用来保存将要执行的指令的偏移地址,而 cs 则是用来保存将要执行的指令的段地址,于是 cs:ip 用来指向要执行的那条指令.<br />
FL 是标志(flag)寄存器,它里面的16个位分别代表不同的意义,其中有些 bit 表示指令执行以后的状态,有些则可以控制 CPU 的行为.<br />
如 FL 的第0位称为 CF 位,其用来存储当前指令的进位.</p>
<pre><code>mov ax,0FFFFh
add ax,1 # AX = 0 , CF = 1
jnc no_carry_flag #jnc:jump if not carry flag
jc has_carry_flag #jc:jump if carry flag

has_carry_flag:
</code></pre>
<p>date 段和 code 段是连续的. <code>ds:[20] = cs:[0]</code><br />
16位的 CPU 运行在实模式(real mode)下,用户代码拥有和操作系统一样的权限,可以执行任何指令,可以访问任何内存.32位的 CPU 除了可以继续运行在实模式下外,还可以运行在保护模式(protected mode)下.在保护模式下,用户代码的权限低于操作系统的权限,并不能执行任何指令,不能越权访问操作系统及其他进程占用的内存空间.<br />
32位的 CPU 中,cs,ds,es,ss 仍旧为16位的宽度,其他内存器都变成了32位,如 eax,ebx,ecx,edx,esi,edi,esp,ebp,eip,EFL.<br />
32位的 CPU 最多可以访问 4G (2^{32})字节内存空间.<br />
实模式和保护模式下的段意义不同,例如当 ds = 8,esi  = 45678h 时,求 ds:esi 的物理地址.<br />
gdt 称为全局描述符表(global descriptor table)是一个数组,数组的每个元素都是8个字节.<br />
有一个寄存器叫 gdtr 会被赋值为 gdt 表的首地址.</p>
<pre><code>#设 gdt 表的首地址为 t:
t + 0 -&gt; gdt[0]
t + 8 -&gt; gdt[1]
t + 10h -&gt; gdt[2]
t + 18h -&gt; gdt[3]
</code></pre>
<p>把 ds 和 t 相加指向 <code>gdt[1]</code>,假定 <code>gdt[1]</code> 的8字节如下所示:<br />
0  1  2  3  4  5  6   7 #下标<br />
<em>FF</em>,<em>FF</em>,00,00,10,93,0 <em>F</em>,00 #值<br />
段首地址取2,3,4,7位,此处为00100000h,于是 ds:45678h对应的物理地址为: 00100000h + 45678h = 00145678h.<br />
斜体的部分用来定义段内的最大偏移地址,此处为 FFFFFh;6位的高位表.
第5位 93h 用来规定这是一个数据段,且可读可写,规定该段的访问权限是 ring 0. 93h = 1 <em>00</em> 1 0011,权限由斜体部分决定.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../javascripts/mathjax.js" defer></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
